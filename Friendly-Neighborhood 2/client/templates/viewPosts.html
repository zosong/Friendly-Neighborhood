<!DOCTYPE html>
<head>
  <meta charset="UTF-8" />
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
  />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css"
    rel="stylesheet"
  />
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" type="text/css" href="/static/style.css" />
</head>

<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/webApp">Friendly Neighborhood</a>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="navbarDropdown"
              role="button"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              My Account
            </a>
            <div
              class="dropdown-menu dropdown-menu-right"
              aria-labelledby="navbarDropdown"
            >
              <a class="dropdown-item" href="/profile">Profile</a>
              <a class="dropdown-item" href="/myPosts">My Posts</a>
              <a class="dropdown-item" href="/blockList">Block List</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="/logout">Log Out</a>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- End Navigation Bar -->
  <div>
    <h1>Friendly-Neighborhood</h1>
    <h2>Posts in {{ ZipCode }}</h2>
    <table border="1">
      <thead>
        <td>Title</td>
        <td>Description</td>
        <td>User</td>
        {% if role == 'admin' or (role == 'moderator' and mod_zip == ZipCode) %}
        <td>Delete</td>
        {% endif %}
      </thead>

      {% for post in posts %}
      <tr>
        <td>
          <a href="/viewPostDetail?postId={{ post.id }}">{{ post.title }}</a>
        </td>
        <td>{{ post.text }}</td>
        <td>{{ post.username }}</td>
        {% if role == 'admin' or (role == 'moderator' and mod_zip == ZipCode) %}
        <td>
          <form action="{{ url_for('deletePost') }}" method="POST">
            <input type="hidden" name="postId" value="{{ post.id }}" />
            <input
              type="hidden"
              name="deleteFromViewPosts"
              value="{{ ZipCode }}"
            />
            <input type="submit" value="Delete" />
          </form>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </table>

    <!-- Mapbox -->
    <div id="map" style="width: 100%; height: 250px"></div>
    <script>
      var mapFeatrues = [];
      var posts = {{ posts|tojson }};
      for(var i = 0; i < posts.length; i++){
          var item = {}
          item["type"] = "Feature";
          item["geometry"] = {};
          item["geometry"]["type"] = "Point";
          item["geometry"]["coordinates"] = [posts[i].longitude, posts[i].latitude];
          item["properties"] = {};
          item["properties"]["title"] = posts[i].title;
          mapFeatrues.push(item)
      }

      var longitude = "{{ Longitude}}";
      var latitude = "{{ Latitude}}";

      mapboxgl.accessToken =
        "pk.eyJ1Ijoic2ViYXNibGFuY28iLCJhIjoiY2xyaWJkdnhtMDUxZzJrbzh4Mnpsb2w5ZyJ9.vb1YW3PO0r8QM3QXzci7rA";
      var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v12",
        center: [longitude, latitude],
        zoom: 12,
      });
      map.addControl(new mapboxgl.NavigationControl());

      map.on("style.load", function () {
        map.addSource("markers", {
                type: "geojson",
                data: {
                    type: "FeatureCollection",
                    features: mapFeatrues
                },
            }
        );

        map.addLayer({
          id: "markers",
          type: "symbol",
          source: "markers",
          layout: {
            "icon-image": "{marker-symbol}-15",
            "text-field": "{title}",
            "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
            "text-offset": [0, 0],
            "text-anchor": "top",
          },
          paint:{
              "text-color": "#000099"
          }
        });
      });
    </script>
    <a href="/viewPosts">Back to search</a>
    <br />
    <a href="/webApp">Back to home</a>
  </div>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>
